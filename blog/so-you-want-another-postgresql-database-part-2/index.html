<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Maven">
    <link rel="icon" href="https://s3.amazonaws.com/awstrackmaven/img/favicon.ico">

    <title>
The Engine Room - TrackMaven
    </title>
    <script type="text/javascript">
      (function(d) {
        var config = {
          kitId: 'mgb7pvk',
          scriptTimeout: 3000
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='//use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
      })(document);
    </script>
    <link href="http://engineroom.trackmaven.com/theme/css/github.css" rel="stylesheet">
    <link href="http://engineroom.trackmaven.com/theme/css/main.css" rel="stylesheet">
  </head>
  <body>
    <div class="wrap">
      <div class="blog-masthead">
        <div class="container">
          <div class="row">
            <div class="col-md-3">
              <img class="logo" src="http://engineroom.trackmaven.com/theme/images/logo@2x.png"/ >
            </div>
            <div class="col-md-7">
              <h1 class="blog-title">
                <a href="http://engineroom.trackmaven.com/">The Engine Room</a>
              </h1>
            </div>
            <div class="col-md-2 mobile-placement">
              <a class="ribbon float-right" href="http://trackmaven.theresumator.com/apply/EzkTn4/Software-Maven.html">We're Hiring!</a>
            </div>
          </div>
        </div>
      </div>
       <div class="container">
<div class="blog-post">
  <h2 class="blog-post-title">So You Want Another PostgreSQL Database? (Part 2)</h2>
  <p class="blog-post-meta">Posted on October 18, 2014 by <a href="http://engineroom.trackmaven.com/author/john-young/">John Young</a><br>Category: <a href="/category/devops/">DevOps</a> | <a href="http://engineroom.trackmaven.com/blog/so-you-want-another-postgresql-database-part-2/#disqus_thread"></a></p>
  <div class="blog-post-content"><p><strong>Read <a href="http://engineroom.trackmaven.com/blog/so-you-want-another-postgresql-database-part-1/">Part 1</a></strong></p>
<h2>Automatic nightly base backups to Amazon S3 using WAL-E</h2>
<p>In the first part of this series of posts, we set up streaming replication between a primary database and a replica database by shipping WAL files between them. While functional, it lacks the robustness and safety that a production database requires. To add an additional layer of protection to our process, we ship our WAL files to S3 so that our replica can ALWAYS bring itself up to date regardless of an enormous write load on the primary or a temporary network disruption preventing the primary and replica from communicating with each other. </p>
<p>We also create a base backup of our database nightly and send that to S3 so that we can restore our database to any point in time we need in case of catastrophe. With a base backup and the WAL files written since that backup was taken, your database can very easily be recovered to any point in time you specify.</p>
<h3>S3</h3>
<ul>
<li>First things first, create a bucket on S3 to store our backups</li>
<li>Turn on versioning as a safeguard against file manipulation</li>
<li>Create a user in AWS IAM to have Put access to the S3 bucket</li>
<li>Give the user read/put access, but NOT delete access. If, for some reason, our database server is compromised and an attacker gets our AWS credentials for this user, they will be able to overwrite our files but not delete them. Thanks to versioning, overwriting of our files is a non-issue. If the name of our bucket is db-backup, a policy like this will do:</li>
</ul>
<div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;Version&quot;</span><span class="o">:</span> <span class="s2">&quot;2014-05-14&quot;</span><span class="o">,</span>
  <span class="s2">&quot;Statement&quot;</span><span class="o">:</span> <span class="cp">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;Stmt1399394132000&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="err">[</span>
        <span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
        <span class="s2">&quot;s3:ListBucket&quot;</span><span class="p">,</span>
        <span class="s2">&quot;s3:PutObject&quot;</span>
      <span class="cp">]</span><span class="o">,</span>
      <span class="s2">&quot;Resource&quot;</span><span class="o">:</span> <span class="cp">[</span>
        <span class="s2">&quot;arn:aws:s3:::db-backup&quot;</span><span class="p">,</span>
        <span class="s2">&quot;arn:aws:s3:::db-backup/*&quot;</span>
      <span class="cp">]</span>
    <span class="p">}</span>
  <span class="o">]</span>
<span class="err">}</span>
</pre></div>


<ul>
<li>Create a new user, making sure to save their AWS credentials (access key AND secret key), and add them to the newly created group</li>
</ul>
<h3>Master and Slave Database Servers</h3>
<p>Install WAL-E and its dependencies, then set it up by saving your bucket name, AWS user's access key, and AWS user's secret key.</p>
<ul>
<li><code>sudo apt-get install daemontools python-dev lzop pv python-pip</code></li>
<li>I ran into problems with my older version of six, so just to be safe... <code>sudo pip install -U six</code></li>
<li><code>sudo pip install wal-e</code></li>
<li>Set up WAL-E:</li>
</ul>
<div class="highlight"><pre><span class="n">umask</span> <span class="n">u</span><span class="o">=</span><span class="n">rwx</span><span class="p">,</span><span class="n">g</span><span class="o">=</span><span class="n">rx</span><span class="p">,</span><span class="n">o</span><span class="o">=</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">wal</span><span class="o">-</span><span class="n">e</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">env</span>
<span class="n">echo</span> <span class="s">&quot;&lt;AWS SECRET KEY&gt;&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">wal</span><span class="o">-</span><span class="n">e</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">env</span><span class="o">/</span><span class="n">AWS_SECRET_ACCESS_KEY</span>
<span class="n">echo</span> <span class="s">&quot;&lt;AWS ACCESS KEY&gt;&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">wal</span><span class="o">-</span><span class="n">e</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">env</span><span class="o">/</span><span class="n">AWS_ACCESS_KEY_ID</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">s3</span><span class="o">:</span><span class="c1">//db-backup/&#39; | sudo tee /etc/wal-e.d/env/WALE_S3_PREFIX</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">root</span><span class="o">:</span><span class="n">postgres</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">wal</span><span class="o">-</span><span class="n">e</span><span class="p">.</span><span class="n">d</span>
</pre></div>


<ul>
<li>That's all there is to it when it comes to setting up WAL-E. Ensure that the following options are set correctly in /etc/postgresql/9.3/main/postgresql.conf:</li>
</ul>
<div class="highlight"><pre><span class="n">wal_level</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">hot_standby</span><span class="err">&#39;</span>
<span class="n">archive_mode</span> <span class="o">=</span> <span class="n">on</span>
<span class="n">archive_command</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">envdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">wal</span><span class="o">-</span><span class="n">e</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">env</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wal</span><span class="o">-</span><span class="n">e</span> <span class="n">wal</span><span class="o">-</span><span class="n">push</span> <span class="o">%</span><span class="n">p</span><span class="err">&#39;</span>
<span class="n">archive_timeout</span> <span class="o">=</span> <span class="mi">60</span>
</pre></div>


<ul>
<li>Become the postgres user: <code>su - postgres</code></li>
<li>Set up a cron job: </li>
<li><code>crontab -e</code></li>
<li><code>0 2 * * * /usr/bin/envdir /etc/wal-e.d/env /usr/local/bin/wal-e backup-push /data/trackmaven</code> will push a base backup of the master database to S3 at 2am nightly</li>
</ul>
<p>We will also need to clean up our S3 bucket by deleting old base backups. This can be done manually, but can also be done with WAL-E. You will need to add Delete permissions to the bucket before WAL-E can do it, so understand the risks that are associated with that. The following command will keep the 5 most recent base backups and delete all others at 2:30am nightly. We could schedule it to run after the nightly backup like this:</p>
<ul>
<li><code>crontab -e</code></li>
<li><code>30 2 * * * /usr/bin/envdir /etc/wal-e.d/env /usr/local/bin/wal-e delete --confirm retain 5</code></li>
</ul></div>
<p class="blog-post-meta">Tags: <a href="/tag/postgres/">postgres</a>, <a href="/tag/double-database/">double-database</a>, <a href="/tag/how-to/">how-to</a></p>  <div class="well">
    <div class="row">
      <div class="col-md-3"> 
        <span class="side-image john-young-avatar col-sm-3"></span>
      </div>
      <div class="col-md-9"> 
        <h3>John Young</h3>
<p class="well-content">I am a Software Maven at <a href="http://trackmaven.com/">TrackMaven</a>.</p>
<p class="well-content">Follow me on <a href="https://twitter.com/johnyoungdev">Twitter</a>.</p>      </div>
    </div>
  </div>
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</div><!-- /.blog-post -->
        </div>
      </div>
    </div>
    <div class="blog-footer">
      <p>&copy; 2014 - TrackMaven <a href="/feeds/rss.xml"><i class="fa fa-rss fa-fw"></i></a></p>
    </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-54925402-1', 'auto');
  ga('send', 'pageview');
</script>
<script type="text/javascript">
var disqus_shortname = 'tmengineroom';
(function() {
  // Comments
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

  // Comment Count
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
  </body>
</html>