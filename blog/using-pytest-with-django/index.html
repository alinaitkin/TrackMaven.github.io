<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Maven">
    <link rel="icon" href="https://s3.amazonaws.com/awstrackmaven/img/favicon.ico">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://engineroom.trackmaven.com/feeds/rss.xml">

    <title>
Using pytest with Django - The Engine Room - TrackMaven
    </title>
    <script type="text/javascript">
      (function(d) {
        var config = {
          kitId: 'mgb7pvk',
          scriptTimeout: 3000
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='//use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
      })(document);
    </script>
    <script src="//use.typekit.net/mgb7pvk.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>

    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-548862822413d8b2" async="async"></script>

    <link href="http://engineroom.trackmaven.com/theme/css/github.css" rel="stylesheet">
    <link href="http://engineroom.trackmaven.com/theme/css/main.css" rel="stylesheet">
  </head>
  <body>
    <div class="wrap">
      <div class="blog-masthead">
        <div class="container">
          <div class="row">
            <div class="col-sm-6">
              <a href="http://engineroom.trackmaven.com/"><img class="logo" src="http://engineroom.trackmaven.com/theme/images/logo@2x.png"/ ></a>
              <h1 class="blog-title">
                <a href="http://engineroom.trackmaven.com/">The Engine Room</a>
              </h1>
            </div>
            <div class="col-md-6 mobile-placement">
              <a class="ribbon float-right" href="https://boards.greenhouse.io/trackmaven/jobs/41377">We're Hiring!</a>
            </div>
          </div>
        </div>
      </div>
       <div class="container">
<div class="blog-post single">
  <h2 class="blog-post-title centered">Using pytest with Django</h2>
  <p class="blog-post-meta single">Posted on <strong>December 08, 2015</strong> by <a href="http://engineroom.trackmaven.com/author/cameron-maske/">Cameron Maske</a><br>Category: <a href="/category/development/">Development</a> | <a href="http://engineroom.trackmaven.com/blog/using-pytest-with-django/#disqus_thread"></a></p>
  <div class="blog-post-content">
    <p>When it comes to testing in python <a href="http://pytest.org/latest/"><code>pytest</code></a> is my favorite testing tool. <code>pytest</code> is a testing framework that strips out boilerplate and adds a whole bunch of sensible utilities to make your tests more pythonic. In this post we'll cover how to add that awesomeness to a Django project.</p>
<h3>Comparing <code>unitest</code> to <code>pytest</code></h3>
<h4><code>unittest</code></h4>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">TestExample</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_hello_world</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">,</span> <span class="s">&quot;hello world&quot;</span><span class="p">)</span>
</pre></div>


<h4><code>pytest</code></h4>
<div class="highlight"><pre>def test_hello_world():
    assert &quot;hello_world&quot; == &quot;hello_world&quot;
</pre></div>


<p>In our newer Django projects we've been using <code>pytest</code> instead of the default test runner. Django's prefer testing is built on top of <a href="https://github.com/django/django/blob/2ab244ff3a799b1a49550a7e7582c4b46e402197/django/test/testcases.py#L155">unittest</a>. Luckily for any <code>pytest</code> fans, this makes it easy to have <code>pytest</code> be a drop in <a href="https://pytest.org/latest/unittest.html">replacement</a> without having to change a single test.</p>
<h1>How?</h1>
<p>Let's dive into how you can setup <code>pytest</code> on your Django projects. For this post, I've created an repo with a dummy Django 1.8 <a href="https://github.com/TrackMaven/using-pytest-with-django">project</a>.  It's local development environment is managed by <a href="http://engineroom.trackmaven.com/blog/a-better-development-environment-with-docker-and-fig/">Docker + Docker Compose.</a>. All code examples are pulled from there.</p>
<p>We'll need one more library in addition to <code>pytest</code>  to get everything working smoothly with Django. <a href="https://pytest-django.readthedocs.org"><code>pytest-django</code></a> takes care of replicating <a href="https://docs.djangoproject.com/en/1.8/topics/testing/tools/#transactiontestcase">Django's existing testing functionality</a> into <code>pytest</code>.</p>
<p>In our <a href="https://github.com/TrackMaven/using-pytest-with-django/blob/master/requirements-dev.txt"><code>requirements-dev.txt</code></a> we've can add in the two packages to be installed.</p>
<div class="highlight"><pre>pytest==2.7.2
pytest-django==2.8.0
</pre></div>


<blockquote>
<p>These were the latest versions when this post was written, be sure to check pypi if either <a href="https://pypi.python.org/pypi/pytest"><code>pytest</code></a> or <a href="https://pypi.python.org/pypi/pytest-django"><code>pytest-django</code></a> have been updated.</p>
</blockquote>
<p>We need to bootstrap <code>pytest</code> with our Django project <a href="https://docs.djangoproject.com/en/1.8/topics/settings/">settings</a>.</p>
<p><code>pytest-django</code>'s documentation <a href="https://pytest-django.readthedocs.org/en/latest/configuring_django.html">recommends</a> a few different ways to achieve this. I'd advocate loading them in through a global <code>conftest.py</code></p>
<p>In <code>pytest</code> any <code>conftest.py</code> files are invoked before any tests are run. They provide a convenient method to setup hooks or configure any settings for our tests.
Where the <code>conftest.py</code> lives dictates the scope of where it applies. If present in the root test folder, hooks declared will apply to all tests. If present in a specific module, hooks will only apply to tests in that module.</p>
<div class="highlight"><pre>tests/
├── conftest.py # Applies to all tests
└── example/
    ├── conftest.py # Applies only to tests in this module/folder.
    ├── test_foo.py
</pre></div>


<p>In our case, we want the <a href="https://github.com/TrackMaven/using-pytest-with-django/blob/master/tests/conftest.py"><code>conftest.py</code></a> to apply to all tests therefore we place it in our tests root directory.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">django</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="c"># We manually designate which settings we will be using in an environment variable</span>
<span class="c"># This is similar to what occurs in the `manage.py`</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">,</span> <span class="s">&#39;app.config.settings&#39;</span><span class="p">)</span>


<span class="c"># `pytest` automatically calls this function once when tests are run.</span>
<span class="k">def</span> <span class="nf">pytest_configure</span><span class="p">():</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># If you have any test specific settings, you can declare them here,</span>
    <span class="c"># e.g.</span>
    <span class="c"># settings.PASSWORD_HASHERS = (</span>
    <span class="c">#     &#39;django.contrib.auth.hashers.MD5PasswordHasher&#39;,</span>
    <span class="c"># )</span>
    <span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
    <span class="c"># Note: In Django =&lt; 1.6 you&#39;ll need to run this instead</span>
    <span class="c"># settings.configure()</span>
</pre></div>


<p>If setup correctly, you should now be able to run the test suite. Instead of running tests through <code>manage.py</code> you run them through the <code>py.test</code> command directly.</p>
<div class="highlight"><pre><span class="nv">$ </span>docker-compose run web py.test
<span class="o">===</span> <span class="nb">test </span>session <span class="nv">starts</span> <span class="o">===</span>
platform linux -- Python 3.3.6 -- py-1.4.30 -- pytest-2.7.2
rootdir: /code, inifile:
plugins: django
collected <span class="m">3</span> items

tests/integration_tests/example/test_models.py ..
tests/unit_tests/example/test_helpers.py .

<span class="o">===</span> <span class="m">3</span> passed in 2.95 <span class="nv">seconds</span> <span class="o">===</span>
</pre></div>


<p>To run a specific test in a module/file, you just include the path after the command, like so <code>py.test &lt;path&gt;</code>.</p>
<div class="highlight"><pre>docker-compose run web py.test tests/integration_tests/example/test_models.py
=== test session starts ===
platform linux -- Python 3.3.6 -- py-1.4.30 -- pytest-2.7.2
rootdir: /code/tests/integration_tests/example, inifile:
plugins: django
collected 2 items

tests/integration_tests/example/test_models.py ..

=== 2 passed in 2.92 seconds ===
</pre></div>


<p>To run a specific test, point <code>py.test</code> to a specific file and test name, like so <code>py.test &lt;path_to_file&gt;::&lt;name_of_test&gt;</code>.</p>
<div class="highlight"><pre><span class="nv">$ </span>docker-compose run web py.test tests/integration_tests/example/test_models.py::test_save
<span class="o">===</span> <span class="nb">test </span>session <span class="nv">starts</span> <span class="o">===</span>
platform linux -- Python 3.3.6 -- py-1.4.30 -- pytest-2.7.2
rootdir: /code/tests/integration_tests/example, inifile:
plugins: django
collected <span class="m">2</span> items

tests/integration_tests/example/test_models.py .

<span class="o">===</span> <span class="m">1</span> passed in 2.94 <span class="nv">seconds</span> <span class="o">===</span>
</pre></div>


<h3>Existing tests.</h3>
<p>As mentioned previously, any existing Django <code>unittest</code> style tests will work out of the box. Here is an <a href="https://github.com/TrackMaven/using-pytest-with-django/blob/master/tests/integration_tests/example/test_models.py">example</a>.</p>
<div class="highlight"><pre><span class="c"># Any existing `unittest` style tests still work without any changes needed.</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>


<span class="k">class</span> <span class="nc">ExampleTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maven</span> <span class="o">=</span> <span class="n">Dog</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Maven&quot;</span><span class="p">,</span> <span class="n">breed</span><span class="o">=</span><span class="s">&quot;corgi&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maven</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maven</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Maven&quot;</span><span class="p">)</span>
        <span class="c"># You can mix in pytest&#39;s `assert` approach!</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">maven</span><span class="o">.</span><span class="n">breed</span> <span class="o">==</span> <span class="s">&quot;corgi&quot;</span>
</pre></div>


<h4>Database testing</h4>
<p>One key difference to watch out for is running <code>pytest</code> style tests against the database.</p>
<p>By default, <code>pytest-django</code> takes a conservative approach to enabling database access in tests.  Any <code>pytest</code> style tests will fail if they try to access the database.
In order to allow database access to a test, you need add a <a href="http://pytest.org/latest/mark.html"><code>py.test mark</code></a> decorator like so...</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">example.models</span> <span class="kn">import</span> <span class="n">Dog</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c"># If your tests need to use the database and want to use pytest</span>
<span class="c"># function test approach, you need to `mark` it.</span>
<span class="nd">@pytest.mark.django_db</span>
<span class="k">def</span> <span class="nf">test_save</span><span class="p">():</span>
    <span class="n">maven</span> <span class="o">=</span> <span class="n">Dog</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Maven&quot;</span><span class="p">,</span> <span class="n">breed</span><span class="o">=</span><span class="s">&quot;corgi&quot;</span><span class="p">)</span>
    <span class="n">maven</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">maven</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;Maven&quot;</span>
    <span class="k">assert</span> <span class="n">maven</span><span class="o">.</span><span class="n">breed</span> <span class="o">==</span> <span class="s">&quot;corgi&quot;</span>
</pre></div>


<p>That's it! You can now take full advantage of <code>pytest</code> in your Django project.</p>

<p class="blog-post-meta footer-meta"><strong>Tags:</strong> <a href="/tag/django/">django</a>, <a href="/tag/pytest/">pytest</a></p>
    <div class="addthis_sharing_toolbox"></div>
  </div>
  <div class="well">
    <div class="row">
      <div class="col-md-3">
        <span class="side-image well-image cameron-maske-avatar col-sm-3"></span>
      </div>
      <div class="col-md-9">
        <h3>Cameron Maske</h3>
<p class="well-content">I am the Lead Architect Maven at <a href="http://trackmaven.com/">TrackMaven</a>.</p>
<p class="well-content">Check out my open source efforts on <a href="https://github.com/cameronmaske">Github</a>. Want to get in touch? Feel free to drop me an <a href="mailto:cam@trackmaven.com">email</a> or <a href="http://twitter.com/cameronmaske">tweet</a>.</p>      </div>
    </div>
  </div>
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</div><!-- /.blog-post -->
        </div>
      </div>
    </div>
    <div class="blog-footer">
      <p>&copy; <script>document.write(new Date().getFullYear())</script><noscript>2015</noscript> - TrackMaven, Inc &bull; <a href="/feeds/rss.xml">RSS</a></p>
    </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-54925402-1', 'auto');
  ga('send', 'pageview');
</script>
<script type="text/javascript">
var disqus_shortname = 'tmengineroom';
(function() {
  // Comments
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

  // Comment Count
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
  </body>
</html>